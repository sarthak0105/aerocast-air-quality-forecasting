<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Data - Delhi Air Quality</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 { font-size: 3em; margin-bottom: 10px; }
        .nav-bar { background: rgba(255, 255, 255, 0.1); padding: 15px 0; text-align: center; }
        .nav-links { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
        .nav-links a {
            color: white; text-decoration: none; padding: 10px 20px;
            border-radius: 25px; transition: all 0.3s ease; font-weight: 500;
        }
        .nav-links a:hover, .nav-links a.active { background: rgba(255, 255, 255, 0.2); }
        .controls { padding: 30px; background: #f8f9fa; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 15px 30px; border-radius: 25px;
            cursor: pointer; font-size: 16px; font-weight: 600;
        }
        .btn:hover { transform: translateY(-2px); }
        .content { padding: 30px; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .stat-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .chart-container { height: 400px; margin: 20px 0; background: white; padding: 20px; border-radius: 15px; }
        .loading { text-align: center; padding: 40px; color: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Historical Air Quality Data</h1>
            <p>Analyze past air quality trends and patterns in Delhi NCR</p>
            <div class="nav-bar">
                <div class="nav-links">
                    <a href="/"><i class="fas fa-home"></i> Dashboard</a>
                    <a href="/historical" class="active"><i class="fas fa-chart-line"></i> Historical</a>
                    <a href="/analytics"><i class="fas fa-chart-bar"></i> Analytics</a>
                    <a href="/settings"><i class="fas fa-cog"></i> Settings</a>
                </div>
            </div>
        </div>

        <div class="controls">
            <div style="text-align: center;">
                <button class="btn" onclick="loadData()">
                    <i class="fas fa-search"></i> Load Historical Data
                </button>
            </div>
        </div>

        <div class="content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="avg-no2">--</div>
                    <div>Avg NO2 (μg/m³)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-o3">--</div>
                    <div>Avg O3 (μg/m³)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="max-aqi">--</div>
                    <div>Max AQI</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="data-points">--</div>
                    <div>Data Points</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Time Series Analysis</h3>
                <canvas id="timeChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>Monthly Averages</h3>
                <canvas id="monthChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>AQI Distribution</h3>
                <canvas id="pieChart"></canvas>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Loading data...
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        function generateData() {
            const data = [];
            const now = new Date();
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                
                const no2 = 30 + Math.random() * 40;
                const o3 = 40 + Math.random() * 30;
                const aqi = Math.round(Math.max(no2 * 2, o3 * 1.5));
                
                data.push({ date, no2, o3, aqi });
            }
            return data;
        }

        function updateStats(data) {
            const avgNO2 = data.reduce((sum, d) => sum + d.no2, 0) / data.length;
            const avgO3 = data.reduce((sum, d) => sum + d.o3, 0) / data.length;
            const maxAQI = Math.max(...data.map(d => d.aqi));
            
            document.getElementById('avg-no2').textContent = avgNO2.toFixed(1);
            document.getElementById('avg-o3').textContent = avgO3.toFixed(1);
            document.getElementById('max-aqi').textContent = maxAQI;
            document.getElementById('data-points').textContent = data.length;
        }

        function createTimeChart(data) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            if (charts.time) charts.time.destroy();
            
            charts.time = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date.toLocaleDateString()),
                    datasets: [{
                        label: 'NO2',
                        data: data.map(d => d.no2),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: false
                    }, {
                        label: 'O3',
                        data: data.map(d => d.o3),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createMonthChart(data) {
            const ctx = document.getElementById('monthChart').getContext('2d');
            if (charts.month) charts.month.destroy();
            
            const monthData = {};
            data.forEach(d => {
                const month = d.date.toLocaleDateString('en-US', { month: 'short' });
                if (!monthData[month]) monthData[month] = { no2: [], o3: [] };
                monthData[month].no2.push(d.no2);
                monthData[month].o3.push(d.o3);
            });
            
            const months = Object.keys(monthData);
            const avgNO2 = months.map(m => monthData[m].no2.reduce((a,b) => a+b, 0) / monthData[m].no2.length);
            const avgO3 = months.map(m => monthData[m].o3.reduce((a,b) => a+b, 0) / monthData[m].o3.length);
            
            charts.month = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'NO2 Avg',
                        data: avgNO2,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)'
                    }, {
                        label: 'O3 Avg',
                        data: avgO3,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createPieChart(data) {
            const ctx = document.getElementById('pieChart').getContext('2d');
            if (charts.pie) charts.pie.destroy();
            
            const categories = { 'Good': 0, 'Moderate': 0, 'Unhealthy': 0, 'Very Unhealthy': 0 };
            data.forEach(d => {
                if (d.aqi <= 50) categories['Good']++;
                else if (d.aqi <= 100) categories['Moderate']++;
                else if (d.aqi <= 200) categories['Unhealthy']++;
                else categories['Very Unhealthy']++;
            });
            
            charts.pie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6f42c1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function loadData() {
            console.log('Loading historical data...');
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            setTimeout(() => {
                try {
                    const data = generateData();
                    console.log('Generated data:', data.length, 'points');
                    
                    updateStats(data);
                    createTimeChart(data);
                    createMonthChart(data);
                    createPieChart(data);
                    
                    loading.style.display = 'none';
                    console.log('✅ All charts created successfully!');
                } catch (error) {
                    console.error('❌ Error:', error);
                    loading.innerHTML = '<div style="color: red;">Error loading data</div>';
                }
            }, 1000);
        }

        // Auto-load on page load
        window.addEventListener('load', function() {
            console.log('📊 Historical page loaded');
            setTimeout(loadData, 500);
        });
    </script>
</body>
</html>